import { prisma } from "../db";

/**
 * Persist a generated drill JSON blob into the DB (Drill table).
 * Returns { saved: boolean, id?: string }.
 *
 * NOTE: Callers should pass a fully post-processed json:
 * - json.goalMode set
 * - json.goalsSupported set (array of ints)
 * - canonicalized equipment already set
 */
export async function saveGeneratedDrill(json: any) {
  // Minimal, type-safe Drill creation
  const data = {
    title: String(json?.title ?? "Untitled"),
    gameModelId: String(json?.gameModelId ?? "COACHAI"),
    phase: String(json?.phase ?? "ATTACKING"),
    zone: String(json?.zone ?? "ATTACKING_THIRD"),
    ageGroup: String(json?.ageGroup ?? "U12"),
    coachLevel: String(json?.coachLevel ?? "advanced"),
    playerLevel: String(json?.playerLevel ?? "developing"),
    durationMin: Number(json?.durationMin ?? 20),
    numbersMin: Number(json?.numbersMin ?? 10),
    numbersMax: Number(json?.numbersMax ?? 12),
    gkOptional: Boolean(json?.gkOptional ?? true),
    spaceConstraint: String(json?.spaceConstraint ?? "HALF"),
    goalsSupported: Array.isArray(json?.goalsSupported)
      ? (json.goalsSupported as number[])
      : (typeof json?.goalsAvailable === "number" ? [Number(json.goalsAvailable)] : []),
    json: json ?? {},
  } as const;

  const rec = await prisma.drill.create({ data });

  // Optional QA persistence (only if the generator attached qa)
  const qa = json?.qa ?? null;
  if (qa) {
    await prisma.qAReport.create({
      data: {
        pass: Boolean(qa?.pass ?? true),
        scores: (qa?.scores ?? {} as any),
        artifact: { connect: { id: rec.id } },
      }
    });
  }

  return { saved: true, id: rec.id };
}


